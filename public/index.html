<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Epick Chat</title>
<script src="/socket.io/socket.io.js"></script>
<style>
body{margin:0;font-family:sans-serif;background:#0f1114;color:#e8eefc;}
.navbar{display:flex;justify-content:space-between;padding:12px;background:#111;}
.tabs{display:flex;gap:8px;margin:12px;}
.tab{padding:8px;background:#222;cursor:pointer;}
.tab.active{background:#6b8cff;color:#fff;}
.panel{display:none;padding:12px;background:#111;}
.panel.active{display:block;}
.list-item{padding:6px;background:#222;margin:2px;cursor:pointer;}
.chat-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);display:none;flex-direction:column;}
.chat-messages{flex:1;overflow:auto;padding:12px;}
.chat-input{display:flex;gap:6px;padding:6px;}
</style>
</head>
<body>
<div class="navbar">
<div>Epick Chat</div>
<div>
<button id="logoutBtn">Logout</button>
</div>
</div>

<div class="tabs">
<div class="tab active" data-tab="friends">Friends</div>
<div class="tab" data-tab="rooms">Rooms</div>
<div class="tab" data-tab="dms">DMs</div>
</div>

<section id="friends" class="panel active">
<h4>Friends</h4>
<div id="friendsList" class="list"></div>
</section>
<section id="rooms" class="panel">
<h4>Rooms</h4>
<div id="roomsList" class="list"></div>
</section>
<section id="dms" class="panel">
<h4>DMs</h4>
<div id="dmList" class="list"></div>
</section>

<div id="chatOverlay" class="chat-overlay">
<div id="chatTitle"></div>
<div id="chatMessages" class="chat-messages"></div>
<div class="chat-input">
<input id="chatInput" placeholder="Message">
<button id="sendBtn">Send</button>
</div>
</div>

<script>
(async function(){
const socket = io();
let me=null,current=null;

const tabs = document.querySelectorAll('.tab');
const panels = document.querySelectorAll('.panel');
tabs.forEach(tab=>tab.addEventListener('click',()=>{
  tabs.forEach(t=>t.classList.remove('active'));
  panels.forEach(p=>p.classList.remove('active'));
  tab.classList.add('active');
  document.getElementById(tab.dataset.tab).classList.add('active');
}));

document.getElementById('logoutBtn').onclick = async ()=>{ await fetch('/logout',{method:'POST'}); location.reload(); }

const friendsListDiv = document.getElementById('friendsList');
const roomsListDiv = document.getElementById('roomsList');
const dmListDiv = document.getElementById('dmList');
const chatOverlay = document.getElementById('chatOverlay');
const chatMessages = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');
const sendBtn = document.getElementById('sendBtn');
const chatTitle = document.getElementById('chatTitle');

async function api(path,opt={}){const r=await fetch(path,opt);return r.json();}

async function init(){
  const meRes = await api('/me');
  if(!meRes.loggedIn) return alert('Not logged in');
  me=meRes.username;
  loadFriends(); loadRooms(); loadDMs();
  socket.emit('registerUser', me);
}

async function loadFriends(){
  const data = await api('/friends');
  friendsListDiv.innerHTML='';
  data.friends.forEach(f=>{
    const el=document.createElement('div');
    el.className='list-item'; el.innerText=f.username;
    el.onclick=()=>openDM(f.username);
    friendsListDiv.appendChild(el);
  });
}
async function loadRooms(){
  const data = await api('/rooms');
  roomsListDiv.innerHTML='';
  Object.entries(data).forEach(([id,r])=>{
    const el=document.createElement('div');
    el.className='list-item'; el.innerText=r.name;
    roomsListDiv.appendChild(el);
  });
}
async function loadDMs(){
  const data = await api('/friends');
  dmListDiv.innerHTML='';
  data.friends.forEach(f=>{
    const el=document.createElement('div');
    el.className='list-item'; el.innerText=f.username;
    el.onclick=()=>openDM(f.username);
    dmListDiv.appendChild(el);
  });
}

function appendMessage(msg){
  const el=document.createElement('div');
  el.innerText = msg.sender + ': '+msg.message;
  chatMessages.appendChild(el);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

function openDM(username){
  current={type:'dm',id:username};
  chatTitle.innerText='@'+username;
  chatMessages.innerHTML='';
  chatOverlay.style.display='flex';
  fetch(`/dm/${username}`).then(r=>r.json()).then(d=>{
    if(d.success) d.messages.forEach(m=>appendMessage(m));
  });
}

sendBtn.onclick = ()=>{
  if(!current) return;
  const msg = chatInput.value.trim();
  if(!msg) return;
  socket.emit(current.type+'Message',{to:current.id,message:msg});
  chatInput.value='';
}

socket.on('dmMessage', m=>{
  if(current?.type==='dm' && (current.id===m.sender || current.id===m.to))
    appendMessage(m);
});

await init();
})();
</script>
</body>
</html>
