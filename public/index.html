<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Epick Chat</title>
<script src="/socket.io/socket.io.js"></script>
<style>
/* --- Base --- */
body { 
  margin:0; font-family:Arial, sans-serif; 
  background:#1e1f22; color:#fff;
  overflow:hidden;
}
.navbar {
  display:flex; justify-content:space-between; align-items:center;
  background:rgba(30,30,35,0.7); backdrop-filter:blur(10px);
  padding:12px 20px; box-shadow:0 2px 10px rgba(0,0,0,0.3);
}
.tabs { display:flex; background:rgba(30,30,35,0.5); }
.tab { 
  flex:1; text-align:center; padding:12px; cursor:pointer; 
  transition:background 0.3s, transform 0.2s;
}
.tab:hover { background:rgba(255,255,255,0.1); transform:scale(1.05);}
.tab.active { background:rgba(114,137,218,0.5); }
.content { padding:15px; display:none; height:calc(100vh - 120px); overflow-y:auto; }
.content.active { display:block; animation:fadeIn 0.3s ease; }

.friend, .room, .dm {
  background:rgba(64,68,75,0.6); backdrop-filter:blur(8px);
  margin:6px 0; padding:10px; border-radius:10px;
  display:flex; justify-content:space-between; align-items:center;
  cursor:pointer; transition:0.3s;
}
.friend:hover, .room:hover, .dm:hover { background:rgba(88,101,242,0.7); }

input, button {
  background:rgba(47,49,54,0.6); color:#fff; border:none;
  padding:8px; margin:5px 0; border-radius:6px;
}
button { cursor:pointer; background:rgba(88,101,242,0.8); transition:0.3s; }
button:hover { background:rgba(71,82,196,0.9); }

.chatbox { 
  height:calc(100% - 100px); overflow-y:auto;
  border-radius:10px; padding:10px; 
  background:rgba(47,49,54,0.7); backdrop-filter:blur(6px);
  margin-bottom:10px;
}
.message { margin:4px 0; display:flex; align-items:center; }
.avatar { width:32px; height:32px; border-radius:50%; margin-right:8px; }
.notification {
  position:fixed; bottom:10px; right:10px;
  background:#5865f2; padding:8px 12px; border-radius:10px;
  color:#fff; z-index:2000; animation:fadeIn 0.3s, fadeOut 0.5s 2.5s forwards;
}
@keyframes fadeIn { from{opacity:0;} to{opacity:1;} }
@keyframes fadeOut { to{opacity:0; transform:translateY(20px);} }

/* --- Chat Panel Modal --- */
.chat-panel {
  position:fixed; top:0; left:0; width:100%; height:100%;
  background:rgba(20,20,25,0.9); backdrop-filter:blur(10px);
  display:none; flex-direction:column; z-index:1500;
  animation:fadeIn 0.3s ease;
}
.chat-panel.active { display:flex; }
.chat-panel-header {
  display:flex; justify-content:space-between; align-items:center;
  padding:10px 15px; background:rgba(30,30,35,0.7);
  box-shadow:0 2px 6px rgba(0,0,0,0.3);
}
.close-btn { cursor:pointer; font-size:20px; color:#fff; }

/* --- Loader --- */
#loader {
  position:fixed; top:0; left:0; width:100%; height:100%;
  background:#1e1f22; display:flex; align-items:center; justify-content:center;
  z-index:3000; font-size:24px; font-weight:bold; color:#7289da;
}
</style>
</head>
<body>
<div id="loader">Loading...</div>

<div class="navbar">
  <h2 id="welcome">Welcome</h2>
  <div>
    <button id="accountBtn">Account</button>
    <button id="adminBtn" style="display:none;">Admin Panel</button>
    <button id="logoutBtn">Logout</button>
  </div>
</div>

<div class="tabs">
  <div class="tab active" data-tab="friends">Friends</div>
  <div class="tab" data-tab="rooms">Rooms</div>
  <div class="tab" data-tab="dms">DMs</div>
</div>

<!-- Friends -->
<div id="friends" class="content active">
  <h3>Friends</h3>
  <input type="text" id="searchUser" placeholder="Search username">
  <button id="searchBtn">Search</button>
  <div id="searchResults"></div>
  <h4>Recently Registered</h4>
  <div id="recentUsers"></div>
  <h4>Requests</h4>
  <div id="friendRequests"></div>
  <h4>Your Friends</h4>
  <div id="friendsList"></div>
</div>

<!-- Rooms -->
<div id="rooms" class="content">
  <h3>Rooms</h3>
  <input type="text" id="roomName" placeholder="Room name">
  <input type="password" id="roomPassword" placeholder="Password (optional)">
  <label><input type="checkbox" id="inviteOnly"> Invite Only</label>
  <button id="createRoomBtn">Create Room</button>
  <div id="inviteBox"></div>
  <h4>Starred Rooms</h4>
  <div id="starredRooms"></div>
  <h4>Available Rooms</h4>
  <div id="roomsList"></div>
</div>

<!-- DMs -->
<div id="dms" class="content">
  <h3>Direct Messages</h3>
  <div id="dmList"></div>
</div>

<!-- Fullscreen Chat Panel -->
<div id="chatPanel" class="chat-panel">
  <div class="chat-panel-header">
    <h4 id="chatTitle"></h4>
    <span id="closeChat" class="close-btn">&times;</span>
  </div>
  <div class="chatbox" id="chatBox"></div>
  <div style="display:flex; gap:5px; padding:10px;">
    <input type="text" id="chatInput" placeholder="Type a message" style="flex:1;">
    <button id="sendChatBtn">Send</button>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const loader = document.getElementById("loader");
  setTimeout(()=> loader.style.display="none", 800);

  const socket = io();
  let currentUser=null, isAdmin=false;
  let chatContext=null; // {type:"room"/"dm", id:"roomId"/"username"}

  function showNotification(msg){
    const n=document.createElement("div");
    n.className="notification"; n.innerText=msg;
    document.body.appendChild(n);
    setTimeout(()=>n.remove(),3000);
  }

  // Tabs
  document.querySelectorAll(".tab").forEach(tab=>{
    tab.addEventListener("click",()=>{
      document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
      document.querySelectorAll(".content").forEach(c=>c.classList.remove("active"));
      tab.classList.add("active");
      document.getElementById(tab.dataset.tab).classList.add("active");
    });
  });

  // Account/logout
  document.getElementById("accountBtn").onclick=()=>window.location.href="/account.html";
  document.getElementById("logoutBtn").onclick=async()=>{
    await fetch("/logout",{method:"POST"});
    window.location.href="/login.html";
  };

  // Init
  async function init(){
    const res=await fetch("/me"); const data=await res.json();
    if(!data.loggedIn) return window.location.href="/login.html";
    currentUser=data.username; isAdmin=data.admin||false;
    document.getElementById("welcome").innerText=`Welcome, ${currentUser}`;
    if(isAdmin) document.getElementById("adminBtn").style.display="inline-block";
    socket.emit("registerUser", currentUser);
    loadFriends(); loadRooms();
  }

  // Chat Panel
  function openChat(type,id,title){
    chatContext={type,id};
    document.getElementById("chatTitle").innerText=title;
    document.getElementById("chatPanel").classList.add("active");
    document.getElementById("chatBox").innerHTML="";
    if(type==="room") socket.emit("joinRoom",{roomId:id,username:currentUser});
    else loadDmMessages(id);
  }
  document.getElementById("closeChat").onclick=()=>{
    document.getElementById("chatPanel").classList.remove("active");
    chatContext=null;
  };
  document.getElementById("chatInput").addEventListener("keydown",e=>{
    if(e.key==="Enter") document.getElementById("sendChatBtn").click();
  });
  document.getElementById("sendChatBtn").onclick=()=>{
    const msg=document.getElementById("chatInput").value.trim();
    if(!msg||msg.length>300||!chatContext) return;
    if(chatContext.type==="room")
      socket.emit("roomMessage",{roomId:chatContext.id,username:currentUser,message:msg});
    else socket.emit("dmMessage",{to:chatContext.id,from:currentUser,message:msg});
    document.getElementById("chatInput").value="";
  };

  function renderMessage(msg){
    const box=document.getElementById("chatBox");
    const div=document.createElement("div"); div.className="message";
    const av=document.createElement("img"); av.src=msg.avatar||'/default.png'; av.className="avatar";
    const span=document.createElement("span"); span.innerHTML=`<b>${msg.sender}:</b> ${msg.message}`;
    div.appendChild(av); div.appendChild(span); box.appendChild(div);
    box.scrollTop=box.scrollHeight;
  }

  socket.on("roomMessage", msg=>{
    if(chatContext?.type==="room" && chatContext.id===msg.roomId) renderMessage(msg);
  });
  socket.on("dmMessage", msg=>{
    if(chatContext?.type==="dm" && (msg.sender===chatContext.id||msg.sender===currentUser)) renderMessage(msg);
    else showNotification(`New DM from ${msg.sender}`);
  });

  // Friends
  async function loadFriends(){ /* same as before, simplified */ }
  // Rooms
  async function loadRooms(){ /* fetch rooms and render with star button, openChat on click */ }
  async function loadDmMessages(friend){ /* fetch DMs and render */ }

  init();
});
</script>
</body>
</html>
