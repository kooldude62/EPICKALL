<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Epick Chat</title>
<script src="/socket.io/socket.io.js"></script>
<style>
:root{ --bg:#0f1114; --panel:rgba(255,255,255,0.04); --muted:rgba(255,255,255,0.6); --accent:#6b8cff; --glass:rgba(255,255,255,0.03); --glass-2:rgba(255,255,255,0.02) }
*{box-sizing:border-box;}
body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#071021,#0f1114);color:#e8eefc;min-height:100vh}
.navbar{display:flex;justify-content:space-between;padding:12px 20px;background:var(--glass-2);border-bottom:1px solid rgba(255,255,255,0.02)}
.tabs{display:flex;gap:8px;margin:16px;padding:0 12px}
.tab{padding:10px 12px;border-radius:10px;background:var(--glass-2);cursor:pointer;color:var(--muted)}
.tab.active{background:linear-gradient(90deg, rgba(107,140,255,0.12), rgba(107,140,255,0.06));color:#fff}
main{display:grid;grid-template-columns:360px 1fr;gap:16px;padding:18px}
.panel{background:var(--panel);border-radius:12px;padding:12px;min-height:60vh;display:none;flex-direction:column;gap:12px}
.panel.active{display:flex}
.list{display:flex;flex-direction:column;gap:6px;max-height:56vh;overflow:auto;padding-right:6px}
.list-item{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));cursor:pointer}
.pfp{width:36px;height:36px;border-radius:50%;object-fit:cover;border:1px solid rgba(255,255,255,0.04)}
.chat-overlay{position:fixed;inset:0;background:linear-gradient(180deg, rgba(1,4,8,0.85), rgba(1,4,8,0.95));display:flex;flex-direction:column;z-index:1200}
.chat-overlay.hidden{display:none}
.chat-messages{flex:1;padding:18px;overflow:auto;display:flex;flex-direction:column;gap:10px}
.chat-input{display:flex;gap:8px;padding:14px;border-top:1px solid rgba(255,255,255,0.02)}
.chat-input input{flex:1;padding:12px;border-radius:10px;background:rgba(255,255,255,0.02);color:#fff;border:1px solid rgba(255,255,255,0.03)}
.chat-message{display:flex;gap:10px;align-items:flex-start}
.chat-message .bubble{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:10px;border-radius:10px;max-width:72%}
.chat-message.me .bubble{background:linear-gradient(180deg, rgba(107,140,255,0.14), rgba(107,140,255,0.08));align-self:flex-end}
.bubble .actions{margin-top:4px;font-size:12px;display:flex;gap:6px;color:var(--muted);cursor:pointer}
.btn{padding:8px 10px;border-radius:8px;border:none;background:var(--accent);color:#05102a;cursor:pointer}
.btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
.small{font-size:13px;color:var(--muted)}
.unread-dot{width:10px;height:10px;border-radius:50%;background:var(--accent);margin-left:8px;flex-shrink:0}
.room-pfp{width:40px;height:40px;border-radius:6px;object-fit:cover;border:1px solid rgba(255,255,255,0.04);margin-right:8px}
.room-manage{margin-left:8px;padding:6px 8px;border-radius:8px;border:none;background:transparent;color:var(--muted);cursor:pointer}
.room-header{display:flex;align-items:center;gap:8px}
</style>
</head>
<body>
<div class="navbar">
  <div class="brand">Epick Chat</div>
  <div style="display:flex;gap:8px">
    <button id="accountBtn" class="btn secondary">Account</button>
    <button id="logoutBtn" class="btn secondary">Logout</button>
  </div>
</div>

<div class="tabs">
  <div class="tab active" data-tab="friends">Friends</div>
  <div class="tab" data-tab="rooms">Rooms</div>
  <div class="tab" data-tab="dms">DMs</div>
</div>

<main>
  <section id="friends" class="panel active">
    <div style="display:flex;gap:8px">
      <input id="searchUser" placeholder="Search username">
      <button id="searchBtn" class="btn secondary">Search</button>
    </div>
    <h4>Recently Registered</h4>
    <div id="recentUsers" class="list"></div>
    <h4>Requests</h4>
    <div id="friendRequests" class="list"></div>
    <h4>Your Friends</h4>
    <div id="friendsList" class="list"></div>
  </section>

  <section id="rooms" class="panel">
    <div style="display:flex;gap:8px;align-items:center">
      <input id="roomName" placeholder="Room name">
      <button id="createRoomBtn" class="btn">Create Room</button>
    </div>
    <h4>Available Rooms</h4>
    <div id="roomsList" class="list"></div>
  </section>

  <section id="dms" class="panel">
    <h4>Direct Messages</h4>
    <div id="dmList" class="list"></div>
  </section>
</main>

<!-- chat overlay -->
<div id="chatOverlay" class="chat-overlay hidden" aria-hidden="true">
  <div style="display:flex;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid rgba(255,255,255,0.02)">
    <div id="chatTitle" class="room-header">Chat</div>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="closeChat" class="btn secondary">Close</button>
    </div>
  </div>

  <div id="chatMessages" class="chat-messages" aria-live="polite"></div>

  <div class="chat-input">
    <input id="chatInput" maxlength="300" placeholder="Type a message (Enter to send)">
    <button id="sendBtn" class="btn">Send</button>
  </div>
</div>

<script>
(async function(){
  const socket = io();
  let me = null, isAdmin = false, current = null, unreadDMs = new Set();
  const tabs = document.querySelectorAll('.tab');
  const panels = document.querySelectorAll('.panel');
  const recentUsersDiv = document.getElementById('recentUsers');
  const friendRequestsDiv = document.getElementById('friendRequests');
  const friendsListDiv = document.getElementById('friendsList');
  const roomsListDiv = document.getElementById('roomsList');
  const dmListDiv = document.getElementById('dmList');
  const chatOverlay = document.getElementById('chatOverlay');
  const chatTitle = document.getElementById('chatTitle');
  const chatMessages = document.getElementById('chatMessages');
  const chatInput = document.getElementById('chatInput');
  const sendBtn = document.getElementById('sendBtn');
  const closeChatBtn = document.getElementById('closeChat');

  function showToast(t){ console.log(t); } // simple placeholder

  // tab switching
  tabs.forEach(tab=>tab.addEventListener('click', ()=>{
    tabs.forEach(t=>t.classList.remove('active'));
    panels.forEach(p=>p.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById(tab.dataset.tab).classList.add('active');
  }));

  document.getElementById('accountBtn').onclick = ()=> location.href = '/account.html';
  document.getElementById('logoutBtn').onclick = async ()=> { await fetch('/logout',{method:'POST'}); location.href = '/login.html'; };

  async function api(path, opts = {}) {
    try {
      const r = await fetch(path, opts);
      return await r.json();
    } catch (e) {
      console.error('API error', path, e);
      return null;
    }
  }

  async function init(){
    const meRes = await api('/me');
    if(!meRes || !meRes.loggedIn) return location.href='/login.html';
    me = meRes.username; isAdmin = !!meRes.admin;
    socket.emit('registerUser', me);
    await Promise.all([loadFriendsAndRecent(), loadRooms(), loadDMList()]);
  }

  // FRIENDS & RECENT
  async function loadFriendsAndRecent(){
    const data = await api('/friends'); if(!data) return;
    // requests
    friendRequestsDiv.innerHTML = '';
    (data.requests||[]).forEach(r=>{
      const el = document.createElement('div'); el.className='list-item';
      el.innerHTML = `<div>${r}</div><div><button class="btn secondary">Accept</button></div>`;
      el.querySelector('button').onclick = async (e)=> {
        e.stopPropagation();
        await fetch('/accept-request',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ from: r })});
        socket.emit('fetchFriends');
        await loadFriendsAndRecent();
      };
      friendRequestsDiv.appendChild(el);
    });

    // friends
    friendsListDiv.innerHTML = '';
    (data.friends||[]).forEach(f=>{
      const el = document.createElement('div'); el.className='list-item';
      el.innerHTML = `<div style="display:flex;align-items:center;gap:8px"><img src="${f.avatar||'/avatars/default.png'}" class="pfp"><div>${f.username}</div></div>`;
      el.onclick = ()=> openDM(f.username);
      friendsListDiv.appendChild(el);
    });

    // recent
    recentUsersDiv.innerHTML = '';
    (data.recent||[]).forEach(u=>{
      const el = document.createElement('div'); el.className='list-item';
      el.innerHTML = `<div style="display:flex;align-items:center;gap:8px"><img src="${u.avatar||'/avatars/default.png'}" class="pfp"><div>${u.username}</div></div><div><button class="btn secondary">Add</button></div>`;
      el.querySelector('button').onclick = async (e)=> {
        e.stopPropagation();
        const resp = await fetch('/friend-request',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ to: u.username })});
        const j = await resp.json();
        showToast(j.success ? 'Requested' : (j.message || 'Error'));
        await loadFriendsAndRecent();
      };
      recentUsersDiv.appendChild(el);
    });
  }

  // ROOMS (show pfp + manage button if owner/admin)
  async function loadRooms(){
    const data = await api('/rooms'); if(!data) return;
    roomsListDiv.innerHTML = '';
    Object.entries(data).forEach(([id, r])=>{
      const el = document.createElement('div'); el.className='list-item';
      // left: pfp + name + owner
      const left = document.createElement('div'); left.style.display='flex'; left.style.alignItems='center';
      const img = document.createElement('img'); img.className='room-pfp'; img.src = r.pfp || '/room_pfps/default.png';
      const meta = document.createElement('div');
      meta.innerHTML = `<div style="font-weight:600">${r.name}</div><div style="font-size:12px;color:var(--muted)">owner: ${r.owner||'—'}</div>`;
      left.appendChild(img); left.appendChild(meta);

      const right = document.createElement('div');
      const joinBtn = document.createElement('button'); joinBtn.className='btn secondary'; joinBtn.textContent='Join';
      joinBtn.onclick = ()=> openRoom(id, r.name);
      right.appendChild(joinBtn);

      // manage if owner or admin
      if (r.owner === me || isAdmin) {
        const manage = document.createElement('button'); manage.className='room-manage'; manage.textContent='Manage';
        manage.onclick = (e) => {
          e.stopPropagation();
          openRoomManageDialog(id, r);
        };
        right.appendChild(manage);
      }

      el.appendChild(left); el.appendChild(right);
      el.onclick = () => openRoom(id, r.name);
      roomsListDiv.appendChild(el);
    });
  }

  // room manage dialog (simple prompt to upload or set URL)
  function openRoomManageDialog(roomId, roomObj){
    // create an invisible file input and a small prompt for url
    const fileInput = document.createElement('input'); fileInput.type='file'; fileInput.accept='image/*';
    fileInput.onchange = async (ev) => {
      if (!fileInput.files || fileInput.files.length === 0) return;
      const fd = new FormData();
      fd.append('pfp', fileInput.files[0]);
      fd.append('roomId', roomId);
      const res = await fetch('/update-room-pfp', { method:'POST', body: fd });
      const j = await res.json();
      if (j.success) { showToast('Room image updated'); await loadRooms(); }
      else alert(j.message || 'Failed');
    };

    const url = prompt('Paste image URL to set as room image (leave empty to upload a file):');
    if (url && url.trim()) {
      // set by url
      fetch('/update-room-pfp', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ roomId, pfpUrl: url.trim() }) })
        .then(r=>r.json()).then(j=>{ if(j.success){ showToast('Room image updated'); loadRooms(); } else alert(j.message||'Failed'); })
        .catch(e=>{ alert('Failed'); });
    } else {
      // trigger file input
      fileInput.click();
    }
  }

  // Create room button
  document.getElementById('createRoomBtn').onclick = async ()=>{
    const name = document.getElementById('roomName').value.trim();
    if (!name) return alert('Enter a room name');
    const res = await fetch('/create-room', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ name }) });
    const j = await res.json();
    if (j.success) { await loadRooms(); openRoom(j.roomId, name); socket.emit('roomsUpdated'); }
    else alert(j.message || 'Create failed');
  };

  // open room
  function openRoom(id, name){
    current = { type: 'room', id };
    setChatHeaderRoom(id, name);
    chatMessages.innerHTML = '';
    chatOverlay.classList.remove('hidden'); chatOverlay.setAttribute('aria-hidden','false');
    socket.emit('joinRoom', { roomId: id });
  }

  async function setChatHeaderRoom(id, name){
    // fetch room info to show pfp
    const info = await api(`/room-info/${id}`);
    const pfp = (info && info.success && info.pfp) ? info.pfp : '/room_pfps/default.png';
    chatTitle.innerHTML = `<img src="${pfp}" style="width:32px;height:32px;border-radius:6px;margin-right:8px"> <span># ${name}</span>`;
  }

  // DMs
  async function loadDMList(){
    const data = await api('/friends'); if(!data) return;
    dmListDiv.innerHTML = '';
    let arr = (data.friends||[]).map(f=>({ ...f, unread: unreadDMs.has(f.username) }));
    // unread first
    arr.sort((a,b)=> (b.unread?1:0) - (a.unread?1:0));
    arr.forEach(f=>{
      const el = document.createElement('div'); el.className='list-item';
      el.innerHTML = `<div style="display:flex;align-items:center;gap:8px"><img src="${f.avatar||'/avatars/default.png'}" class="pfp"><div>@ ${f.username}</div>${f.unread?'<div class="unread-dot"></div>':''}</div>`;
      el.onclick = ()=> openDM(f.username);
      dmListDiv.appendChild(el);
    });
  }

  async function openDM(username){
    current = { type: 'dm', id: username };
    chatTitle.textContent = `@ ${username}`;
    chatMessages.innerHTML = '';
    const r = await api(`/dm/${username}`);
    if (r && r.success) (r.messages||[]).forEach(m=>appendMessage(m));
    chatOverlay.classList.remove('hidden'); chatOverlay.setAttribute('aria-hidden','false');
    unreadDMs.delete(username);
    loadDMList();
  }

  function createMessageElement(m){
    const el = document.createElement('div'); el.className = 'chat-message' + (m.sender===me ? ' me' : '');
    el.dataset.msgid = m.id;
    const av = document.createElement('img'); av.src = m.avatar || '/avatars/default.png'; av.className='pfp';
    const bubble = document.createElement('div'); bubble.className='bubble';
    bubble.innerHTML = `<div style="font-size:12px;color:var(--muted)">${m.sender} • ${new Date(m.time||Date.now()).toLocaleString()}</div><div style="margin-top:6px">${escapeHtml(m.message||'')}</div>`;
    if (m.sender===me || isAdmin) {
      const actions = document.createElement('div');
      actions.className = 'actions';
      actions.innerHTML = `<span data-act="reply">Reply</span> <span data-act="edit">Edit</span> <span data-act="delete">Delete</span>`;
      actions.onclick = async (e) => {
        const act = e.target.dataset.act;
        if (act === 'reply') { chatInput.value = `@${m.sender} ${chatInput.value}`; chatInput.focus(); }
        if (act === 'edit') {
          const newMsg = prompt('Edit message:', m.message);
          if (!newMsg) return;
          await fetch('/edit-message', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ id: m.id, newMsg, dmWith: current?.type==='dm' ? current.id : undefined, roomId: current?.type==='room' ? current.id : undefined }) });
        }
        if (act === 'delete') {
          if (!confirm('Delete message?')) return;
          await fetch('/delete-message', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ id: m.id, dmWith: current?.type==='dm' ? current.id : undefined, roomId: current?.type==='room' ? current.id : undefined }) });
          const container = chatMessages.querySelector(`[data-msgid="${m.id}"]`);
          if (container) container.remove();
        }
      };
      bubble.appendChild(actions);
    }
    el.appendChild(av); el.appendChild(bubble);
    return el;
  }

  function appendMessage(m){
    if(!m || !m.id) return;
    if (document.querySelector(`[data-msgid="${m.id}"]`)) return;
    const el = createMessageElement(m);
    chatMessages.appendChild(el);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // send
  async function sendMessage(){
    const txt = chatInput.value.trim();
    if (!txt) return;
    if (!current) return alert('Open a room or DM first');
    if (current.type === 'room') {
      socket.emit('roomMessage', { roomId: current.id, message: txt });
    } else {
      // optimistic append for DM sender
      const temp = { id: 'temp-'+Date.now(), sender: me, avatar: null, message: txt, time: Date.now(), to: current.id };
      appendMessage(temp);
      socket.emit('dmMessage', { to: current.id, message: txt });
    }
    chatInput.value = '';
  }
  sendBtn.onclick = sendMessage;
  chatInput.addEventListener('keydown', e=> { if (e.key === 'Enter') sendMessage(); });

  // socket handlers
  socket.on('chatHistory', msgs => {
    chatMessages.innerHTML = '';
    (msgs||[]).forEach(m => appendMessage(m));
  });

  socket.on('roomMessage', m => {
    if (current?.type === 'room' && current.id === m.roomId) appendMessage(m);
  });

  socket.on('dmMessage', m => {
    // if DM currently open with partner -> append
    if (current?.type === 'dm' && (current.id === m.sender || current.id === m.to)) {
      appendMessage(m);
    } else {
      const other = (m.sender === me) ? m.to : m.sender;
      unreadDMs.add(other);
      loadDMList();
      showToast(`New DM from ${m.sender}`);
    }
  });

  socket.on('dmNotification', ({from}) => {
    showToast(`New DM from ${from}`);
  });

  socket.on('friendsUpdate', ()=> { loadFriendsAndRecent(); loadDMList(); });
  socket.on('roomsUpdated', ()=> loadRooms());
  socket.on('updateMessage', msg => {
    const el = chatMessages.querySelector(`[data-msgid="${msg.id}"] .bubble div:nth-child(2)`);
    if (el) el.textContent = msg.message || '';
  });
  socket.on('deleteMessage', id => {
    const el = chatMessages.querySelector(`[data-msgid="${id}"]`);
    if (el) el.remove();
  });

  socket.on('connect', ()=> socket.emit('fetchFriends'));

  // helper
  function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  // initialize
  await init();

})();
</script>
</body>
</html>
