<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Epick Chat</title>
<script src="/socket.io/socket.io.js"></script>
<style>
:root{--bg:#0f1114;--panel:rgba(255,255,255,0.04);--muted:rgba(255,255,255,0.6);--accent:#6b8cff}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#071021,#0f1114);color:#e8eefc}
.navbar{display:flex;justify-content:space-between;padding:12px 20px;background:var(--panel);border-bottom:1px solid rgba(255,255,255,0.02)}
.brand{font-weight:700;color:var(--accent)}
.nav-actions{display:flex;gap:8px;align-items:center}
.inbox-btn{position:relative;padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);cursor:pointer}
.inbox-badge{position:absolute;top:-6px;right:-6px;background:var(--accent);color:#05102a;padding:2px 6px;border-radius:999px;font-weight:700;font-size:12px}
.tabs{display:flex;gap:8px;margin:16px;padding:0 12px}
.tab{padding:10px 12px;border-radius:10px;background:transparent;cursor:pointer;color:var(--muted)}
.tab.active{background:linear-gradient(90deg, rgba(107,140,255,0.12), rgba(107,140,255,0.06));color:#fff}
main{display:grid;grid-template-columns:360px 1fr;gap:16px;padding:18px}
.panel{background:var(--panel);border-radius:12px;padding:12px;min-height:60vh;display:none;flex-direction:column;gap:12px}
.panel.active{display:flex}
.list{display:flex;flex-direction:column;gap:6px;max-height:56vh;overflow:auto;padding-right:6px}
.list-item{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));cursor:pointer}
.pfp{width:36px;height:36px;border-radius:50%;object-fit:cover;border:1px solid rgba(255,255,255,0.04)}
.room-pfp{width:40px;height:40px;border-radius:6px;object-fit:cover;border:1px solid rgba(255,255,255,0.04);margin-right:8px}
.chat-overlay{position:fixed;inset:0;background:linear-gradient(180deg, rgba(1,4,8,0.85), rgba(1,4,8,0.95));display:flex;flex-direction:column;z-index:1200}
.chat-overlay.hidden{display:none}
.chat-messages{flex:1;padding:18px;overflow:auto;display:flex;flex-direction:column;gap:10px}
.chat-input{display:flex;gap:8px;padding:14px;border-top:1px solid rgba(255,255,255,0.02)}
.chat-input input{flex:1;padding:12px;border-radius:10px;background:rgba(255,255,255,0.02);color:#fff;border:1px solid rgba(255,255,255,0.03)}
.chat-message{display:flex;gap:10px;align-items:flex-start}
.chat-message .bubble{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:10px;border-radius:10px;max-width:72%}
.chat-message.me .bubble{background:linear-gradient(180deg, rgba(107,140,255,0.14), rgba(107,140,255,0.08));align-self:flex-end}
.bubble .actions{margin-top:6px;font-size:12px;display:flex;gap:8px;color:var(--muted)}
.btn{padding:8px 10px;border-radius:8px;border:none;background:var(--accent);color:#05102a;cursor:pointer}
.btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
.small{font-size:13px;color:var(--muted)}
.unread-dot{width:10px;height:10px;border-radius:50%;background:var(--accent);margin-left:8px;flex-shrink:0}
.inbox-panel{position:absolute;right:12px;top:56px;width:320px;background:var(--panel);border-radius:10px;padding:12px;z-index:1300;box-shadow:0 8px 30px rgba(0,0,0,0.6)}
.inbox-item{display:flex;flex-direction:column;padding:8px;border-radius:8px;border-bottom:1px solid rgba(255,255,255,0.02);cursor:pointer}
.inbox-item.unread{background:linear-gradient(90deg, rgba(107,140,255,0.06), rgba(107,140,255,0.02))}
</style>
</head>
<body>
<div class="navbar">
  <div class="brand">Epick Chat</div>
  <div class="nav-actions">
    <button id="inboxBtn" class="inbox-btn">Inbox <span id="inboxBadge" class="inbox-badge" style="display:none">0</span></button>
    <button id="accountBtn" class="btn secondary">Account</button>
    <button id="logoutBtn" class="btn secondary">Logout</button>
  </div>
</div>

<div id="inboxPanel" class="inbox-panel" style="display:none">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
    <div style="font-weight:700">Inbox</div>
    <div><button id="markAllRead" class="btn secondary">Mark all read</button></div>
  </div>
  <div id="inboxList" style="max-height:300px;overflow:auto"></div>
  <div id="inboxEmpty" style="opacity:0.7;margin-top:8px">No notifications</div>
</div>

<div class="tabs">
  <div class="tab active" data-tab="friends">Friends</div>
  <div class="tab" data-tab="rooms">Rooms</div>
  <div class="tab" data-tab="dms">DMs</div>
</div>

<main>
  <section id="friends" class="panel active">
    <div style="display:flex;gap:8px">
      <input id="searchUser" placeholder="Search username">
      <button id="searchBtn" class="btn secondary">Search</button>
    </div>
    <h4>Recently Registered</h4>
    <div id="recentUsers" class="list"></div>
    <h4>Requests</h4>
    <div id="friendRequests" class="list"></div>
    <h4>Your Friends</h4>
    <div id="friendsList" class="list"></div>
  </section>

  <section id="rooms" class="panel">
    <div style="display:flex;gap:8px;align-items:center">
      <input id="roomName" placeholder="Room name">
      <button id="createRoomBtn" class="btn">Create Room</button>
    </div>
    <h4>Available Rooms</h4>
    <div id="roomsList" class="list"></div>
  </section>

  <section id="dms" class="panel">
    <h4>Direct Messages</h4>
    <div id="dmList" class="list"></div>
  </section>
</main>

<div id="chatOverlay" class="chat-overlay hidden" aria-hidden="true">
  <div style="display:flex;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid rgba(255,255,255,0.02)">
    <div id="chatTitle" style="display:flex;align-items:center;gap:8px">Chat</div>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="closeChat" class="btn secondary">Close</button>
    </div>
  </div>
  <div id="chatMessages" class="chat-messages" aria-live="polite"></div>
  <div class="chat-input">
    <input id="chatInput" maxlength="300" placeholder="Type a message (Enter to send)">
    <button id="sendBtn" class="btn">Send</button>
  </div>
</div>

<script>
(async function(){
  const socket = io();
  let me = null, isAdmin = false, current = null;
  const unreadDMs = new Set();

  // elements
  const inboxBtn = document.getElementById('inboxBtn');
  const inboxBadge = document.getElementById('inboxBadge');
  const inboxPanel = document.getElementById('inboxPanel');
  const inboxList = document.getElementById('inboxList');
  const inboxEmpty = document.getElementById('inboxEmpty');
  const markAllReadBtn = document.getElementById('markAllRead');

  const tabs = document.querySelectorAll('.tab');
  const panels = document.querySelectorAll('.panel');
  const recentUsersDiv = document.getElementById('recentUsers');
  const friendRequestsDiv = document.getElementById('friendRequests');
  const friendsListDiv = document.getElementById('friendsList');
  const roomsListDiv = document.getElementById('roomsList');
  const dmListDiv = document.getElementById('dmList');

  const chatOverlay = document.getElementById('chatOverlay');
  const chatTitle = document.getElementById('chatTitle');
  const chatMessages = document.getElementById('chatMessages');
  const chatInput = document.getElementById('chatInput');
  const sendBtn = document.getElementById('sendBtn');
  const closeChatBtn = document.getElementById('closeChat');

  function showBadge(n) { if(!n || n<=0) {inboxBadge.style.display='none'} else {inboxBadge.style.display=''; inboxBadge.textContent=String(n);} }
  function showInboxPanel(show){ inboxPanel.style.display = show ? '' : 'none'; }

  inboxBtn.onclick = ()=>{ const visible = inboxPanel.style.display !== 'none'; showInboxPanel(!visible); if(!visible) loadInbox(); };

  markAllReadBtn.onclick = async ()=>{ await fetch('/inbox/mark-read',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ id:'all' })}); await loadInbox(); };

  tabs.forEach(tab=>tab.addEventListener('click', ()=>{ tabs.forEach(t=>t.classList.remove('active')); panels.forEach(p=>p.classList.remove('active')); tab.classList.add('active'); document.getElementById(tab.dataset.tab).classList.add('active'); }));

  document.getElementById('accountBtn').onclick = ()=> location.href = '/account.html';
  document.getElementById('logoutBtn').onclick = async ()=> { await fetch('/logout',{method:'POST'}); location.href = '/login.html'; };

  async function api(path, opts={}){ try{ const r = await fetch(path, opts); return await r.json(); } catch(e){ console.error('API error', path, e); return null; } }

  async function init(){
    const meRes = await api('/me');
    if(!meRes || !meRes.loggedIn) return location.href = '/login.html';
    me = meRes.username; isAdmin = !!meRes.admin;
    socket.emit('registerUser', me);
    await Promise.all([loadFriendsAndRecent(), loadRooms(), loadDMList()]);
    await loadInbox();
  }

  // ---------- INBOX ----------
  async function loadInbox(){
    const res = await api('/inbox'); if(!res || !res.success) { inboxList.innerHTML=''; inboxEmpty.style.display=''; showBadge(0); return; }
    const notes = res.notifications || [];
    inboxList.innerHTML = '';
    if(notes.length === 0) inboxEmpty.style.display = ''; else inboxEmpty.style.display = 'none';
    let unreadCount = 0;
    notes.forEach(n=>{
      if(!n.read) unreadCount++;
      const item = document.createElement('div'); item.className='inbox-item' + (n.read ? '' : ' unread');
      item.innerHTML = `<div style="display:flex;justify-content:space-between"><div style="font-weight:600">${n.type}</div><div style="font-size:12px;color:var(--muted)">${formatDate(n.time)}</div></div><div style="margin-top:6px;color:var(--muted);font-size:13px">${renderNotifText(n)}</div>`;
      item.onclick = async ()=>{
        await fetch('/inbox/mark-read',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ id:n.id })});
        if(n.type === 'dm' && n.payload && n.payload.from) openDM(n.payload.from);
        if(n.type === 'friend_request') { tabs.forEach(t=>t.classList.remove('active')); panels.forEach(p=>p.classList.remove('active')); document.querySelector('.tab[data-tab="friends"]').classList.add('active'); document.getElementById('friends').classList.add('active'); loadFriendsAndRecent(); }
        await loadInbox();
      };
      inboxList.appendChild(item);
    });
    showBadge(unreadCount);
  }

  function renderNotifText(n){
    if(n.type === 'dm') return `New DM from ${n.payload.from}`;
    if(n.type === 'friend_request') return `Friend request from ${n.payload.from}`;
    if(n.type === 'friend_accept') return `${n.payload.by} accepted your friend request`;
    return JSON.stringify(n.payload || {});
  }

  socket.on('inboxUpdate', n => {
    if(inboxPanel.style.display !== 'none') loadInbox();
    else {
      const current = parseInt(inboxBadge.textContent || '0') || 0;
      showBadge(current + 1);
    }
  });

  // ---------- FRIENDS ----------
  async function loadFriendsAndRecent(){
    const data = await api('/friends'); if(!data) return;
    friendRequestsDiv.innerHTML = '';
    (data.requests||[]).forEach(r=>{
      const el = document.createElement('div'); el.className='list-item';
      el.innerHTML = `<div>${r}</div><div><button class="btn secondary">Accept</button></div>`;
      el.querySelector('button').onclick = async e=>{
        e.stopPropagation();
        await fetch('/accept-request',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ from:r })});
        socket.emit('fetchFriends');
        await loadFriendsAndRecent();
      };
      friendRequestsDiv.appendChild(el);
    });

    friendsListDiv.innerHTML = '';
    (data.friends||[]).forEach(f=>{
      const el = document.createElement('div'); el.className='list-item';
      el.innerHTML = `<div style="display:flex;align-items:center;gap:8px"><img src="${f.avatar||'/avatars/default.png'}" class="pfp"><div>${f.username}</div></div>`;
      el.onclick = ()=> openDM(f.username);
      friendsListDiv.appendChild(el);
    });

    recentUsersDiv.innerHTML = '';
    (data.recent||[]).forEach(u=>{
      const el = document.createElement('div'); el.className='list-item';
      el.innerHTML = `<div style="display:flex;align-items:center;gap:8px"><img src="${u.avatar||'/avatars/default.png'}" class="pfp"><div>${u.username}</div></div><div><button class="btn secondary">Add</button></div>`;
      el.querySelector('button').onclick = async e=>{
        e.stopPropagation();
        const resp = await fetch('/friend-request',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ to: u.username })});
        const j = await resp.json();
        alert(j.success ? 'Request sent' : j.message || 'Error');
        await loadFriendsAndRecent();
      };
      recentUsersDiv.appendChild(el);
    });
  }

  // ---------- ROOMS ----------
  async function loadRooms(){
    const data = await api('/rooms'); if(!data) return;
    roomsListDiv.innerHTML = '';
    Object.entries(data).forEach(([id, r])=>{
      const el = document.createElement('div'); el.className='list-item';
      const left = document.createElement('div'); left.style.display='flex'; left.style.alignItems='center';
      const img = document.createElement('img'); img.className='room-pfp'; img.src = r.pfp || '/room_pfps/default.png';
      const meta = document.createElement('div'); meta.innerHTML = `<div style="font-weight:600">${r.name}</div><div style="font-size:12px;color:var(--muted)">owner: ${r.owner||'—'}</div>`;
      left.appendChild(img); left.appendChild(meta);
      const right = document.createElement('div');
      const joinBtn = document.createElement('button'); joinBtn.className='btn secondary'; joinBtn.textContent='Join';
      joinBtn.onclick = ()=> openRoom(id, r.name);
      right.appendChild(joinBtn);
      if (r.owner === me || isAdmin) {
        const manage = document.createElement('button'); manage.className='btn secondary'; manage.textContent='Manage';
        manage.onclick = (e)=>{ e.stopPropagation(); openRoomManageDialog(id, r); };
        right.appendChild(manage);
      }
      el.appendChild(left); el.appendChild(right);
      el.onclick = ()=> openRoom(id, r.name);
      roomsListDiv.appendChild(el);
    });
  }

  document.getElementById('createRoomBtn').onclick = async ()=>{
    const name = (document.getElementById('roomName').value || '').trim();
    if(!name) return alert('Enter a room name');
    const res = await fetch('/create-room',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ name })});
    const j = await res.json();
    if(j.success){ await loadRooms(); openRoom(j.roomId, name); socket.emit('roomsUpdated'); } else alert(j.message || 'Create failed');
  };

  function openRoomManageDialog(roomId, roomObj){
    const fileInput = document.createElement('input'); fileInput.type='file'; fileInput.accept='image/*';
    fileInput.onchange = async ()=>{
      if(!fileInput.files || fileInput.files.length===0) return;
      const fd = new FormData(); fd.append('pfp', fileInput.files[0]); fd.append('roomId', roomId);
      const res = await fetch('/update-room-pfp',{ method:'POST', body: fd });
      const j = await res.json();
      if(j.success) { alert('Room image updated'); loadRooms(); }
      else alert(j.message || 'Failed');
    };
    const url = prompt('Paste image URL to set as room image (leave empty to choose a file):');
    if(url && url.trim()) {
      fetch('/update-room-pfp',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ roomId, pfpUrl: url.trim() }) }).then(r=>r.json()).then(j=>{ if(j.success){ alert('Room image updated'); loadRooms(); } else alert(j.message||'Failed'); });
    } else fileInput.click();
  }

  // ---------- DMs ----------
  async function loadDMList(){
    const data = await api('/friends'); if(!data) return;
    dmListDiv.innerHTML = '';
    let friends = (data.friends||[]).map(f=>({ ...f, unread: unreadDMs.has(f.username) }));
    friends.sort((a,b)=> (b.unread?1:0) - (a.unread?1:0));
    friends.forEach(f=>{
      const el = document.createElement('div'); el.className='list-item';
      el.innerHTML = `<div style="display:flex;align-items:center;gap:8px"><img src="${f.avatar||'/avatars/default.png'}" class="pfp"><div>@ ${f.username}</div>${f.unread?'<div class="unread-dot"></div>':''}</div>`;
      el.onclick = ()=> openDM(f.username);
      dmListDiv.appendChild(el);
    });
  }

  // ---------- CHAT ----------
  function setChatHeaderRoom(id, name, pfp) {
    chatTitle.innerHTML = `<img src="${pfp||'/room_pfps/default.png'}" style="width:32px;height:32px;border-radius:6px;margin-right:8px"><span># ${name}</span>`;
  }

  async function openRoom(id, name){
    current = { type:'room', id };
    const info = await api(`/room-info/${id}`);
    setChatHeaderRoom(id, name, (info && info.success) ? info.pfp : '/room_pfps/default.png');
    chatMessages.innerHTML = '';
    chatOverlay.classList.remove('hidden'); chatOverlay.setAttribute('aria-hidden','false');
    socket.emit('joinRoom',{ roomId: id });
  }

  async function openDM(username){
    current = { type:'dm', id: username };
    chatTitle.innerHTML = `<img src="/avatars/default.png" style="width:32px;height:32px;border-radius:50%;margin-right:8px"><span>@ ${username}</span>`;
    chatMessages.innerHTML = '';
    const r = await api(`/dm/${username}`);
    if(r && r.success) (r.messages||[]).forEach(m=>appendMessage(m));
    chatOverlay.classList.remove('hidden'); chatOverlay.setAttribute('aria-hidden','false');
    unreadDMs.delete(username);
    loadDMList();
  }

  function formatDate(ts){
    const d = new Date(ts||Date.now());
    const optsTime = { hour: 'numeric', minute: '2-digit' };
    const timeStr = d.toLocaleTimeString([], optsTime);
    return `${timeStr}, ${d.getMonth()+1}/${d.getDate()}/${d.getFullYear()}`;
  }

  function createMessageElement(m){
    const el = document.createElement('div'); el.className = 'chat-message' + (m.sender===me ? ' me' : '');
    el.dataset.msgid = m.id;
    const av = document.createElement('img'); av.src = m.avatar||'/avatars/default.png'; av.className='pfp';
    const bubble = document.createElement('div'); bubble.className='bubble';
    bubble.innerHTML = `<div style="font-size:12px;color:var(--muted)">${m.sender} • ${formatDate(m.time)}</div><div style="margin-top:6px">${escapeHtml(m.message||'')}</div>`;
    // actions: edit/delete for own or admin
    if(m.sender === me || isAdmin) {
      const actions = document.createElement('div'); actions.className='actions';
      actions.innerHTML = `<span data-act="edit" style="cursor:pointer">Edit</span><span data-act="delete" style="cursor:pointer">Delete</span>`;
      actions.onclick = async (e)=>{
        const act = e.target.dataset.act;
        if(act === 'edit'){ const newMsg = prompt('Edit message:', m.message); if(newMsg!==null) { await fetch('/edit-message',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ id: m.id, newMsg, dmWith: current?.type==='dm' ? current.id : undefined, roomId: current?.type==='room' ? current.id : undefined }) }); } }
        if(act === 'delete'){ if(confirm('Delete message?')) { await fetch('/delete-message',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ id: m.id, dmWith: current?.type==='dm' ? current.id : undefined, roomId: current?.type==='room' ? current.id : undefined }) }); const found = chatMessages.querySelector(`[data-msgid="${m.id}"]`); if(found) found.remove(); } }
      };
      bubble.appendChild(actions);
    }
    el.appendChild(av); el.appendChild(bubble);
    return el;
  }

  // Append with temp replacement behavior
  function appendMessage(m){
    if(!m || !m.id) return;
    if(m.tempId) {
      const optimistic = chatMessages.querySelector(`[data-msgid="${m.tempId}"]`);
      if(optimistic) {
        optimistic.dataset.msgid = m.id;
        const bubble = optimistic.querySelector('.bubble');
        if(bubble) bubble.innerHTML = `<div style="font-size:12px;color:var(--muted)">${m.sender} • ${formatDate(m.time)}</div><div style="margin-top:6px">${escapeHtml(m.message||'')}</div>`;
        const img = optimistic.querySelector('img.pfp');
        if(img && m.avatar) img.src = m.avatar;
        chatMessages.scrollTop = chatMessages.scrollHeight;
        return;
      }
    }
    if(document.querySelector(`[data-msgid="${m.id}"]`)) return;
    const el = createMessageElement(m);
    chatMessages.appendChild(el);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  async function sendMessage(){
    const txt = (chatInput.value || "").trim();
    if(!txt) return;
    if(!current) return alert('Open a room or DM first');
    if(current.type === 'room') {
      socket.emit('roomMessage', { roomId: current.id, message: txt });
    } else {
      const tempId = 'temp-' + Date.now() + '-' + Math.floor(Math.random()*1000);
      const tempMsg = { id: tempId, sender: me, avatar: null, message: txt, time: Date.now(), to: current.id };
      appendMessage(tempMsg);
      socket.emit('dmMessage', { to: current.id, message: txt, tempId });
    }
    chatInput.value = '';
  }

  sendBtn.onclick = sendMessage;
  chatInput.addEventListener('keydown', e=>{ if(e.key === 'Enter') sendMessage(); });

  // socket events
  socket.on('chatHistory', msgs => { chatMessages.innerHTML = ''; (msgs||[]).forEach(m => appendMessage(m)); });
  socket.on('roomMessage', m => { if(current?.type==='room' && current.id === m.roomId) appendMessage(m); });
  socket.on('dmMessage', m => {
    if(current?.type==='dm' && (current.id === m.sender || current.id === m.to)) appendMessage(m);
    else {
      // mark unread and add badge
      const other = (m.sender === me) ? m.to : m.sender;
      unreadDMs.add(other);
      loadDMList();
      const curr = parseInt(inboxBadge.textContent||'0')||0; showBadge(curr+1);
    }
  });
  socket.on('inboxUpdate', ()=> { if(inboxPanel.style.display !== 'none') loadInbox(); else { const curr = parseInt(inboxBadge.textContent||'0')||0; showBadge(curr+1); } });
  socket.on('kickedFromRoom', ({roomId, by, reason}) => {
    if(current?.type==='room' && current.id === roomId) {
      alert(`You were removed from the room by ${by}${reason?(' ('+reason+')'):''}`);
      chatOverlay.classList.add('hidden'); chatOverlay.setAttribute('aria-hidden','true'); current = null;
    }
  });
  socket.on('friendsUpdate', ()=>{ loadFriendsAndRecent(); loadDMList(); });
  socket.on('roomsUpdated', ()=> loadRooms());
  socket.on('updateMessage', msg => {
    const el = chatMessages.querySelector(`[data-msgid="${msg.id}"] .bubble div:nth-child(2)`);
    if(el) el.textContent = msg.message || '';
  });
  socket.on('deleteMessage', id => {
    const el = chatMessages.querySelector(`[data-msgid="${id}"]`);
    if(el) el.remove();
  });

  socket.on('connect', ()=> socket.emit('fetchFriends'));

  // ---------- helpers ----------
  function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  // initial load
  await init();

})();
</script>
</body>
</html>
