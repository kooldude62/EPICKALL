import express from "express";
import http from "http";
import { Server } from "socket.io";
import path from "path";
import { fileURLToPath } from "url";
import bcrypt from "bcryptjs";
import session from "express-session";
import cookieParser from "cookie-parser";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const app = express();
const server = http.createServer(app);
const io = new Server(server);

app.use(express.static(path.join(__dirname, "public")));
app.use(express.json());
app.use(express.urlencoded({ extended: true }));
app.use(cookieParser());
app.use(session({
  secret: "supersecret",
  resave: false,
  saveUninitialized: false
}));

// "Database"
let users = {};   // { username: { password: hashed, pfp: url } }
let rooms = {};   // { roomName: { pass, private } }

// Auth check
function requireLogin(req, res, next) {
  if (!req.session.user) return res.redirect("/login.html");
  next();
}

// Routes
app.get("/", requireLogin, (req, res) => {
  res.sendFile(path.join(__dirname, "public/index.html"));
});

app.get("/account", requireLogin, (req, res) => {
  res.sendFile(path.join(__dirname, "public/account.html"));
});

app.post("/signup", async (req, res) => {
  const { username, password } = req.body;
  if (!username || !password || users[username]) return res.send("Invalid signup.");
  const hashed = await bcrypt.hash(password, 10);
  users[username] = { password: hashed, pfp: "/default.png" };
  req.session.user = username;
  res.redirect("/");
});

app.post("/login", async (req, res) => {
  const { username, password } = req.body;
  if (!username || !password || !users[username]) return res.send("Invalid login.");
  const valid = await bcrypt.compare(password, users[username].password);
  if (!valid) return res.send("Invalid login.");
  req.session.user = username;
  res.redirect("/");
});

app.post("/updateAccount", requireLogin, (req, res) => {
  const { username, pfp } = req.body;
  const current = req.session.user;
  if (username && !users[username]) {
    users[username] = users[current];
    delete users[current];
    req.session.user = username;
  }
  if (pfp) users[req.session.user].pfp = pfp;
  res.redirect("/account");
});

// Socket.io
io.on("connection", (socket) => {
  console.log("User connected");

  socket.on("createRoom", ({ room, password, privateRoom }) => {
    if (!room) return;
    rooms[room] = { pass: password || null, private: privateRoom || false };
    socket.join(room);
    socket.emit("roomJoined", room);
  });

  socket.on("joinRoom", ({ room, password }) => {
    if (!rooms[room]) return socket.emit("errorMsg", "Room not found.");
    if (rooms[room].pass && rooms[room].pass !== password) return socket.emit("errorMsg", "Wrong password.");
    socket.join(room);
    socket.emit("roomJoined", room);
  });

  socket.on("chatMessage", ({ room, user, msg }) => {
    if (!room) return;
    io.to(room).emit("chatMessage", { user, msg });
  });
});

const PORT = process.env.PORT || 3000;
server.listen(PORT, () => console.log(`Server running on http://localhost:${PORT}`));
