<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Epick Chat</title>
<link rel="stylesheet" href="/style.css">
<script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <div id="loader" class="loader-overlay">
    <div class="loader-box">
      <div class="spinner"></div>
      <div>Loading EpickChat…</div>
    </div>
  </div>

  <div class="navbar">
    <div class="brand">Epick Chat</div>
    <div class="nav-actions">
      <button id="accountBtn">Account</button>
      <button id="logoutBtn">Logout</button>
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="friends">Friends</div>
    <div class="tab" data-tab="rooms">Rooms</div>
    <div class="tab" data-tab="dms">DMs</div>
  </div>

  <main>
    <section id="friends" class="panel active">
      <div class="section-header">
        <input id="searchUser" placeholder="Search username">
        <button id="searchBtn">Search</button>
      </div>

      <h4>Recently Registered</h4>
      <div id="recentUsers" class="list"></div>

      <h4>Requests</h4>
      <div id="friendRequests" class="list"></div>

      <h4>Your Friends</h4>
      <div id="friendsList" class="list"></div>
    </section>

    <section id="rooms" class="panel">
      <div class="section-header">
        <input id="roomName" placeholder="Room name">
        <button id="createRoomBtn">Create Room</button>
      </div>

      <h4>Available Rooms</h4>
      <div id="roomsList" class="list"></div>
    </section>

    <section id="dms" class="panel">
      <h4>Direct Messages</h4>
      <div id="dmList" class="list"></div>
    </section>
  </main>

  <!-- Fullscreen chat overlay -->
  <div id="chatOverlay" class="chat-overlay hidden">
    <div class="chat-header">
      <div id="chatTitle">Chat</div>
      <button id="closeChat">✖</button>
    </div>
    <div id="chatMessages" class="chat-messages"></div>
    <div class="chat-input">
      <input id="chatInput" maxlength="300" placeholder="Type a message (Enter to send)"/>
      <button id="sendBtn">Send</button>
    </div>
  </div>

<script>
(async function(){
  const socket = io();
  let me = null;
  let current = null; // { type: 'room'|'dm', id: ... }

  // DOM
  const loader = document.getElementById('loader');
  const accountBtn = document.getElementById('accountBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const tabs = document.querySelectorAll('.tab');
  const panels = document.querySelectorAll('.panel');

  const recentUsersDiv = document.getElementById('recentUsers');
  const friendRequestsDiv = document.getElementById('friendRequests');
  const friendsListDiv = document.getElementById('friendsList');
  const roomsListDiv = document.getElementById('roomsList');
  const dmListDiv = document.getElementById('dmList');

  const chatOverlay = document.getElementById('chatOverlay');
  const chatTitle = document.getElementById('chatTitle');
  const chatMessages = document.getElementById('chatMessages');
  const chatInput = document.getElementById('chatInput');
  const sendBtn = document.getElementById('sendBtn');
  const closeChatBtn = document.getElementById('closeChat');

  function showToast(text){
    const t = document.createElement('div');
    t.className = 'toast';
    t.innerText = text;
    document.body.appendChild(t);
    setTimeout(()=> t.classList.add('visible'), 10);
    setTimeout(()=> t.classList.remove('visible'), 2800);
    setTimeout(()=> t.remove(), 3200);
  }

  // Tab switching
  tabs.forEach(tab=>{
    tab.addEventListener('click', ()=> {
      tabs.forEach(t=>t.classList.remove('active'));
      panels.forEach(p=>p.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById(tab.dataset.tab).classList.add('active');
    });
  });

  accountBtn.onclick = ()=> location.href = '/account.html';
  logoutBtn.onclick = async ()=> {
    await fetch('/logout', { method: 'POST' });
    location.href = '/login.html';
  };

  // initialize
  async function init(){
    const res = await fetch('/me');
    const data = await res.json();
    if (!data.loggedIn) return location.href = '/login.html';
    me = data.username;
    socket.emit('registerUser', me);

    // load lists
    await loadFriendsAndRecent();
    await loadRooms();

    // handle invite param (?invite=roomId)
    const url = new URL(location.href);
    const invite = url.searchParams.get('invite');
    if (invite) {
      const ri = await fetch(`/room-info/${invite}`).then(r=>r.json());
      if (ri.success) openRoom(invite,ri.name);
      else showToast('Invalid invite link');
    }

    setTimeout(()=> loader.classList.add('hidden'), 250);
  }

  // FRIENDS & RECENT
  async function loadFriendsAndRecent(){
    const res = await fetch('/friends');
    const data = await res.json();

    // requests
    friendRequestsDiv.innerHTML = '';
    (data.requests || []).forEach(r=>{
      const el = document.createElement('div'); el.className='list-item';
      el.innerHTML = `<span>${r}</span> <button>Accept</button>`;
      el.querySelector('button').onclick = async ()=> {
        await fetch('/accept-request', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ from: r })});
        socket.emit('fetchFriends');
        showToast('Friend accepted');
        await loadFriendsAndRecent();
      };
      friendRequestsDiv.appendChild(el);
    });

    // friends
    friendsListDiv.innerHTML = '';
    const seen = new Set();
    (data.friends || []).forEach(f=>{
      if (seen.has(f.username)) return;
      seen.add(f.username);
      const el = document.createElement('div'); el.className='list-item';
      el.innerHTML = `<img src="${f.avatar}" class="pfp"> <span>${f.username}</span>`;
      el.onclick = ()=> openDM(f.username);
      friendsListDiv.appendChild(el);
    });

    // recent users
    recentUsersDiv.innerHTML = '';
    (data.recent || []).forEach(u=>{
      const el = document.createElement('div'); el.className='list-item';
      el.innerHTML = `<img src="${u.avatar}" class="pfp"> <span>${u.username}</span> <button>Add</button>`;
      el.querySelector('button').onclick = async (e)=> {
        e.stopPropagation();
        const resp = await fetch('/friend-request', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ to: u.username })});
        const json = await resp.json();
        showToast(json.success ? 'Request sent' : json.message || 'Error');
        await loadFriendsAndRecent();
      };
      recentUsersDiv.appendChild(el);
    });
  }

  // ROOMS
  async function loadRooms(){
    const res = await fetch('/rooms');
    const data = await res.json();
    roomsListDiv.innerHTML = '';
    Object.entries(data).forEach(([id, r])=>{
      const el = document.createElement('div'); el.className='list-item';
      el.innerHTML = `<span>${r.name}</span> <button>Join</button>`;
      el.querySelector('button').onclick = ()=> openRoom(id, r.name);
      roomsListDiv.appendChild(el);
    });
  }

  // Create room
  document.getElementById('createRoomBtn').onclick = async ()=>{
    const name = document.getElementById('roomName').value.trim();
    if (!name) return showToast('Enter room name');
    const res = await fetch('/create-room', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name })});
    const j = await res.json();
    if (j.success) {
      showToast('Room created');
      await loadRooms();
      // open new room
      openRoom(j.roomId, name);
      // update global rooms for everyone
      socket.emit('roomsUpdated');
    } else showToast(j.message || 'Error');
  };

  // OPEN ROOM overlay
  function openRoom(id, name){
    current = { type: 'room', id };
    chatTitle.textContent = `# ${name}`;
    chatMessages.innerHTML = '';
    chatOverlay.classList.remove('hidden');
    // ask server for chat history
    socket.emit('joinRoom', { roomId: id });
  }

  // OPEN DM overlay
  async function openDM(username){
    current = { type: 'dm', id: username };
    chatTitle.textContent = `@ ${username}`;
    chatMessages.innerHTML = '';
    chatOverlay.classList.remove('hidden');
    // fetch DM history
    const r = await fetch(`/dm/${username}`);
    const j = await r.json();
    if (j.success) {
      (j.messages || []).forEach(m => appendMessage(m));
    }
  }

  // append message to overlay
  function appendMessage(m){
    const el = document.createElement('div'); el.className = 'chat-message';
    const av = document.createElement('img'); av.src = m.avatar || '/avatars/default.png'; av.className='pfp';
    const txt = document.createElement('div');
    txt.innerHTML = `<b>${m.sender}</b> <div class="msg-text">${escapeHtml(m.message||m.text||m.msg||'')}</div>`;
    el.appendChild(av); el.appendChild(txt); chatMessages.appendChild(el);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // send button / enter
  sendBtn.onclick = async ()=>{
    const txt = chatInput.value.trim();
    if (!txt) return;
    if (txt.length > 300) return showToast('Messages limited to 300 chars');
    if (!current) return;
    if (current.type === 'room') {
      socket.emit('roomMessage', { roomId: current.id, message: txt });
    } else {
      socket.emit('dmMessage', { to: current.id, message: txt });
    }
    chatInput.value = '';
  };
  chatInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendBtn.click(); });

  // close overlay
  closeChatBtn.onclick = ()=> { chatOverlay.classList.add('hidden'); current = null; };

  // socket handlers
  socket.on('chatHistory', msgs => {
    chatMessages.innerHTML = '';
    (msgs || []).forEach(m => appendMessage(m));
  });
  socket.on('roomMessage', m => {
    if (current && current.type === 'room' && current.id === m.roomId) appendMessage(m);
  });
  socket.on('dmMessage', m => {
    if (current && current.type === 'dm' && current.id === m.sender) appendMessage(m);
    else showToast(`New DM from ${m.sender}`);
  });

  socket.on('dmNotification', ({ from }) => {
    showToast(`New DM from ${from}`);
  });

  socket.on('friendRequest', (from) => {
    showToast(`Friend request from ${from}`);
    loadFriendsAndRecent(); // refresh UI
  });

  socket.on('friendsUpdate', () => {
    loadFriendsAndRecent();
  });

  socket.on('roomsUpdated', () => {
    loadRooms();
  });

  socket.on('connect', ()=> {
    // fetch friends after connect
    socket.emit('fetchFriends');
  });

  // helper: escape html to avoid injection
  function escapeHtml(s){
    return (s||'').toString().replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  // search
  document.getElementById('searchBtn').onclick = async ()=>{
    const q = document.getElementById('searchUser').value.trim();
    if (!q) return showToast('Enter username');
    const container = document.getElementById('recentUsers');
    container.innerHTML = '';
    const el = document.createElement('div'); el.className='list-item';
    el.innerHTML = `<span>${q}</span> <button>Add</button>`;
    el.querySelector('button').onclick = async ()=>{
      const resp = await fetch('/friend-request', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ to: q })});
      const j = await resp.json();
      showToast(j.success ? 'Request sent' : j.message || 'Error');
      await loadFriendsAndRecent();
    };
    container.appendChild(el);
  };

  // initial
  await init();

})();
</script>
</body>
</html>
