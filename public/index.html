<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Chat App</title>
<script src="/socket.io/socket.io.js"></script>
<style>
body { margin:0; font-family:Arial; background:#2c2f33; color:#fff; }
.navbar { display:flex; justify-content:space-between; align-items:center; background:#23272a; padding:10px; }
.tabs { display:flex; background:#23272a; }
.tab { flex:1; text-align:center; padding:12px; cursor:pointer; transition:0.3s; }
.tab:hover { background:#40444b; }
.tab.active { background:#7289da; }
.content { padding:15px; display:none; }
.content.active { display:block; }
.friend, .room, .dm { background:#40444b; margin:6px 0; padding:10px; border-radius:6px; display:flex; justify-content:space-between; cursor:pointer; }
.friend:hover, .room:hover, .dm:hover { background:#5865f2; }
input, button { background:#2f3136; color:#fff; border:none; padding:8px; margin:5px 0; border-radius:4px; }
button { cursor:pointer; background:#5865f2; }
button:hover { background:#4752c4; }
.chatbox { height:300px; overflow-y:auto; border:1px solid #202225; padding:10px; background:#2f3136; border-radius:4px; margin-bottom:10px; }
.message { margin:4px 0; }
.notification { position:fixed; bottom:10px; right:10px; background:#5865f2; padding:8px; border-radius:6px; color:#fff; z-index:1000; }
.avatar { width:32px; height:32px; border-radius:50%; margin-right:8px; }
</style>
</head>
<body>
<div class="navbar">
  <h2 id="welcome">Welcome</h2>
  <div>
    <button id="accountBtn">Account</button>
    <button id="adminBtn" style="display:none;">Admin Panel</button>
    <button id="logoutBtn">Logout</button>
  </div>
</div>

<div class="tabs">
  <div class="tab active" data-tab="friends">Friends</div>
  <div class="tab" data-tab="rooms">Rooms</div>
  <div class="tab" data-tab="dms">DMs</div>
</div>

<!-- Friends Tab -->
<div id="friends" class="content active">
  <h3>Friends</h3>
  <input type="text" id="searchUser" placeholder="Search username">
  <button id="searchBtn">Search</button>
  <div id="searchResults"></div>
  <h4>Requests</h4>
  <div id="friendRequests"></div>
  <h4>Your Friends</h4>
  <div id="friendsList"></div>
</div>

<!-- Rooms Tab -->
<div id="rooms" class="content">
  <h3>Rooms</h3>
  <input type="text" id="roomName" placeholder="Room name">
  <input type="password" id="roomPassword" placeholder="Password (optional)">
  <label><input type="checkbox" id="inviteOnly"> Invite Only</label>
  <button id="createRoomBtn">Create Room</button>
  <div id="inviteBox"></div>
  <h4>Available Rooms</h4>
  <div id="roomsList"></div>
  <div id="roomChat" style="display:none;">
    <h4 id="roomTitle"></h4>
    <div class="chatbox" id="roomChatBox"></div>
    <input type="text" id="roomMsg" placeholder="Type a message">
    <button id="sendRoomMsgBtn">Send</button>
  </div>
</div>

<!-- DMs Tab -->
<div id="dms" class="content">
  <h3>Direct Messages</h3>
  <div id="dmList"></div>
  <div id="dmChat" style="display:none;">
    <h4 id="dmTitle"></h4>
    <div class="chatbox" id="dmChatBox"></div>
    <input type="text" id="dmMsg" placeholder="Type a message">
    <button id="sendDmMsgBtn">Send</button>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const socket = io();
  let currentUser = null, currentRoom = null, currentDm = null, isAdmin = false;

  // --- Notification ---
  function showNotification(msg){
    const notif=document.createElement("div");
    notif.className="notification"; notif.innerText=msg;
    document.body.appendChild(notif);
    setTimeout(()=>notif.remove(),3000);
  }

  // --- Tabs ---
  document.querySelectorAll(".tab").forEach(tab => {
    tab.addEventListener("click", () => {
      const tabName = tab.dataset.tab;
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      document.querySelectorAll(".content").forEach(c => c.classList.remove("active"));
      tab.classList.add("active");
      document.getElementById(tabName).classList.add("active");
    });
  });

  // --- Account & Logout ---
  document.getElementById("accountBtn").addEventListener("click", ()=> window.location.href="/account.html");
  document.getElementById("logoutBtn").addEventListener("click", async ()=>{
    await fetch("/logout",{method:"POST"});
    window.location.href="/login.html";
  });

  // --- Initialize ---
  async function init(){
    const res = await fetch("/me");
    const data = await res.json();
    if(!data.loggedIn) return window.location.href="/login.html";
    currentUser = data.username;
    isAdmin = data.admin || false;
    document.getElementById("welcome").innerText = `Welcome, ${currentUser}`;
    if(isAdmin){
      const btn=document.getElementById("adminBtn");
      btn.style.display="inline-block";
      btn.addEventListener("click", ()=> window.location.href="/admin");
    }
    socket.emit("registerUser", currentUser);
    loadFriends();
    loadRooms();
  }

  // --- Friends ---
  async function loadFriends(){
    const res = await fetch("/friends");
    const data = await res.json();
    const reqsDiv = document.getElementById("friendRequests");
    reqsDiv.innerHTML = "";
    data.requests.forEach(r => {
      const div = document.createElement("div");
      div.className="friend";
      div.innerHTML = `<span>${r}</span>`;
      const btn = document.createElement("button");
      btn.innerText = "Accept";
      btn.addEventListener("click", ()=> acceptRequest(r));
      div.appendChild(btn);
      reqsDiv.appendChild(div);
    });

    const listDiv = document.getElementById("friendsList");
    listDiv.innerHTML = "";
    const dmDiv = document.getElementById("dmList");
    dmDiv.innerHTML = "";
    data.friends.forEach(f=>{
      const fDiv = document.createElement("div");
      fDiv.className="friend";
      fDiv.innerHTML = `<span>${f}</span>`;
      listDiv.appendChild(fDiv);

      const dmItem = document.createElement("div");
      dmItem.className="dm";
      dmItem.innerHTML = `<span>${f}</span>`;
      dmItem.addEventListener("click", ()=> openDm(f));
      dmDiv.appendChild(dmItem);
    });
  }

  async function searchUser(){
    const user = document.getElementById("searchUser").value.trim();
    if(!user || user===currentUser){document.getElementById("searchResults").innerText="Invalid search"; return;}
    const div = document.createElement("div");
    div.className="friend";
    div.innerHTML = `<span>${user}</span>`;
    const btn = document.createElement("button");
    btn.innerText = "Add Friend";
    btn.addEventListener("click", ()=> sendFriendRequest(user));
    div.appendChild(btn);
    document.getElementById("searchResults").innerHTML = "";
    document.getElementById("searchResults").appendChild(div);
  }

  async function sendFriendRequest(to){
    const res = await fetch("/friend-request",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({to})});
    const data = await res.json();
    showNotification(data.success ? "Request sent!" : data.message || "Error");
    loadFriends();
  }

  async function acceptRequest(from){
    await fetch("/accept-request",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({from})});
    loadFriends();
  }

  document.getElementById("searchBtn").addEventListener("click", searchUser);

  // --- Rooms ---
  async function loadRooms(){
    const res = await fetch("/rooms");
    const data = await res.json();
    const listDiv = document.getElementById("roomsList");
    listDiv.innerHTML = "";
    Object.entries(data).forEach(([id,r])=>{
      const div = document.createElement("div");
      div.className="room";
      div.innerText = r.name;
      div.addEventListener("click", ()=> joinRoom(id,r.name));
      listDiv.appendChild(div);
    });
  }

  async function createRoom(){
    const name = document.getElementById("roomName").value;
    const password = document.getElementById("roomPassword").value;
    const inviteOnly = document.getElementById("inviteOnly").checked;
    const res = await fetch("/create-room",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name,password,inviteOnly})});
    const data = await res.json();
    if(data.success){
      const box = document.getElementById("inviteBox");
      box.innerHTML = `<input type="text" value="${data.inviteLink}" readonly>`;
    } else showNotification(data.message);
    loadRooms();
  }

  function joinRoom(id,name){
    currentRoom = id;
    document.getElementById("roomTitle").innerText = name;
    document.getElementById("roomChat").style.display="block";
    document.getElementById("roomChatBox").innerHTML="";
    socket.emit("joinRoom",{roomId:id,username:currentUser});
  }

  document.getElementById("createRoomBtn").addEventListener("click", createRoom);
  document.getElementById("sendRoomMsgBtn").addEventListener("click", ()=>{
    const msg = document.getElementById("roomMsg").value;
    if(!msg) return;
    socket.emit("roomMessage",{roomId:currentRoom,username:currentUser,message:msg});
    document.getElementById("roomMsg").value="";
  });

  // --- Room Messages ---
  function renderMessages(msgs){
    const box = document.getElementById("roomChatBox");
    box.innerHTML = "";
    msgs.forEach(renderMessage);
  }

  function renderMessage(msg){
    const box = document.getElementById("roomChatBox");
    const div = document.createElement("div");
    div.className="message"; div.id=msg.id;
    const controls=[];
    if(msg.sender===currentUser || isAdmin){
      const editBtn = document.createElement("button"); editBtn.innerText="Edit";
      editBtn.addEventListener("click", ()=> editMessage(msg.id));
      const delBtn = document.createElement("button"); delBtn.innerText="Delete";
      delBtn.addEventListener("click", ()=> deleteMessage(msg.id));
      controls.push(editBtn,delBtn);
    }
    div.innerHTML=`<b>${msg.sender}:</b> <span class="text">${msg.message}</span> `;
    controls.forEach(c=>div.appendChild(c));
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
  }

  async function editMessage(msgId){
    const newMsg = prompt("Edit message:");
    if(!newMsg) return;
    await fetch("/edit-message",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({roomId:currentRoom,msgId,newMsg})});
  }

  async function deleteMessage(msgId){
    await fetch("/delete-message",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({roomId:currentRoom,msgId})});
  }

  socket.on("chatHistory", renderMessages);
  socket.on("roomMessage", renderMessage);
  socket.on("updateMessage", msg=>{
    const el=document.getElementById(msg.id);
    if(el) el.querySelector(".text").innerText=msg.message;
  });
  socket.on("deleteMessage", msgId=>{
    const el=document.getElementById(msgId); if(el) el.remove();
  });

  // --- DMs ---
  function openDm(friend){
    currentDm=friend;
    document.getElementById("dmTitle").innerText=`Chat with ${friend}`;
    document.getElementById("dmChat").style.display="block";
    loadDmMessages(friend);
  }

  async function loadDmMessages(friend){
    const res = await fetch(`/dm/${friend}`);
    const data = await res.json();
    const box = document.getElementById("dmChatBox");
    box.innerHTML = "";
    if(data.success){
      data.messages.forEach(m=>{
        const div=document.createElement("div");
        div.className="message";
        div.innerHTML=`<b>${m.sender}:</b> ${m.message}`;
        box.appendChild(div);
      });
    }
  }

  document.getElementById("sendDmMsgBtn").addEventListener("click", ()=>{
    const msg=document.getElementById("dmMsg").value;
    if(!msg) return;
    socket.emit("dmMessage",{to:currentDm,from:currentUser,message:msg});
    document.getElementById("dmMsg").value="";
  });

  socket.on("dmMessage", msg=>{
    if(msg.sender===currentDm || msg.sender===currentUser){
      const box=document.getElementById("dmChatBox");
      const div=document.createElement("div");
      div.className="message";
      div.innerHTML=`<b>${msg.sender}:</b> ${msg.message}`;
      box.appendChild(div);
      box.scrollTop=box.scrollHeight;
    } else showNotification(`New message from ${msg.sender}`);
  });

  socket.on("dmNotification", data=>{
    const {from} = data;
    if(currentDm!==from) showNotification(`New message from ${from}`);
  });

  // --- Init ---
  init();
});
</script>
</body>
</html>
