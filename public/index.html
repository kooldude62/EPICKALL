<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Epick Chat</title>
<script src="/socket.io/socket.io.js"></script>
<style>
:root{
  --bg:#0f1114; --panel: rgba(255,255,255,0.04);
  --muted: rgba(255,255,255,0.6); --accent: #6b8cff;
  --glass: rgba(255,255,255,0.03); --glass-2: rgba(255,255,255,0.02);
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui; background:linear-gradient(180deg,#071021 0%, #0f1114 100%);color:#e8eefc;}
.loader-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(5,7,10,0.7);backdrop-filter:blur(4px);z-index:9999;}
.loader-box{display:flex;flex-direction:column;gap:12px;align-items:center;padding:18px;border-radius:12px;background:var(--glass);}
.spinner{width:40px;height:40px;border-radius:50%;border:4px solid rgba(255,255,255,0.08);border-top-color:var(--accent);animation:spin 1s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
.navbar{display:flex;justify-content:space-between;align-items:center;padding:12px 20px;background:var(--glass-2);}
.brand{font-weight:700;letter-spacing:0.4px;color:var(--accent);}
.nav-actions button{margin-left:8px;padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--muted);cursor:pointer;transition:.18s;}
.nav-actions button:hover{transform:translateY(-1px);}
.tabs{display:flex;gap:0;margin:16px;padding:0 12px;}
.tab{flex:1;padding:10px 12px;text-align:center;background:var(--glass-2);border-radius:10px;color:var(--muted);cursor:pointer;transition:.12s;border:1px solid rgba(255,255,255,0.02);}
.tab.active{background:linear-gradient(90deg, rgba(107,140,255,0.12), rgba(107,140,255,0.06));color:#fff;}
main{display:grid;grid-template-columns:360px 1fr;gap:16px;padding:18px;}
.panel{background:var(--panel);border-radius:12px;padding:12px;min-height:60vh;display:none;flex-direction:column;gap:12px;}
.panel.active{display:flex;}
.list{display:flex;flex-direction:column;gap:6px;max-height:56vh;overflow:auto;padding-right:6px;}
.list-item{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));cursor:pointer;}
.list-item:hover{transform:translateY(-4px);}
.pfp{width:36px;height:36px;border-radius:50%;object-fit:cover;border:1px solid rgba(255,255,255,0.04);}
.chat-overlay{position:fixed;inset:0;background:rgba(1,4,8,0.95);display:flex;flex-direction:column;z-index:1200;opacity:1;transition:opacity .12s;}
.chat-overlay.hidden{display:none;}
.chat-messages{flex:1;padding:18px;overflow:auto;display:flex;flex-direction:column;gap:10px;}
.chat-input{display:flex;gap:8px;padding:14px;border-top:1px solid rgba(255,255,255,0.02);}
.chat-input input{flex:1;padding:12px;border-radius:10px;background:rgba(255,255,255,0.02);color:#fff;border:1px solid rgba(255,255,255,0.03);}
.chat-message{display:flex;gap:10px;align-items:flex-start;}
.chat-message .bubble{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:10px;border-radius:10px;max-width:72%;}
.chat-message.me .bubble{background:linear-gradient(180deg, rgba(107,140,255,0.14), rgba(107,140,255,0.08));align-self:flex-end;}
</style>
</head>
<body>
<div id="loader" class="loader-overlay">
  <div class="loader-box">
    <div class="spinner"></div>
    <div>Loading EpickChatâ€¦</div>
  </div>
</div>

<div class="navbar">
  <div class="brand">Epick Chat</div>
  <div class="nav-actions">
    <button id="accountBtn">Account</button>
    <button id="logoutBtn">Logout</button>
  </div>
</div>

<div class="tabs">
  <div class="tab active" data-tab="friends">Friends</div>
  <div class="tab" data-tab="rooms">Rooms</div>
  <div class="tab" data-tab="dms">DMs</div>
</div>

<main>
  <section id="friends" class="panel active">
    <div class="section-header">
      <input id="searchUser" placeholder="Search username">
      <button id="searchBtn">Search</button>
    </div>
    <h4>Recently Registered</h4>
    <div id="recentUsers" class="list"></div>
    <h4>Requests</h4>
    <div id="friendRequests" class="list"></div>
    <h4>Your Friends</h4>
    <div id="friendsList" class="list"></div>
  </section>
  <section id="rooms" class="panel">
    <div class="section-header">
      <input id="roomName" placeholder="Room name">
      <button id="createRoomBtn">Create Room</button>
    </div>
    <h4>Available Rooms</h4>
    <div id="roomsList" class="list"></div>
  </section>
  <section id="dms" class="panel">
    <h4>Direct Messages</h4>
    <div id="dmList" class="list"></div>
  </section>
</main>

<div id="chatOverlay" class="chat-overlay hidden">
  <div class="chat-header">
    <div id="chatTitle">Chat</div>
    <button id="closeChat">Close</button>
  </div>
  <div id="chatMessages" class="chat-messages"></div>
  <div class="chat-input">
    <input id="chatInput" placeholder="Type a message">
    <button id="sendBtn">Send</button>
  </div>
</div>

<script>
(async function(){
  const socket = io();
  let me = null, current = null;
  const messageMap = new Map();

  const loader = document.getElementById('loader');
  const tabs = document.querySelectorAll('.tab');
  const panels = document.querySelectorAll('.panel');
  const recentUsersDiv = document.getElementById('recentUsers');
  const friendRequestsDiv = document.getElementById('friendRequests');
  const friendsListDiv = document.getElementById('friendsList');
  const roomsListDiv = document.getElementById('roomsList');
  const dmListDiv = document.getElementById('dmList');
  const chatOverlay = document.getElementById('chatOverlay');
  const chatMessages = document.getElementById('chatMessages');
  const chatInput = document.getElementById('chatInput');
  const sendBtn = document.getElementById('sendBtn');
  const closeChatBtn = document.getElementById('closeChat');

  tabs.forEach(tab => tab.addEventListener('click',()=>{
    tabs.forEach(t=>t.classList.remove('active'));
    panels.forEach(p=>p.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById(tab.dataset.tab).classList.add('active');
  }));

  document.getElementById('logoutBtn').onclick = async ()=>{ await fetch('/logout',{method:'POST'}); location.href='/login.html'; };

  async function api(path){ const r=await fetch(path); return r.ok?await r.json():null; }

  async function init(){
    const meRes = await api('/me');
    if(!meRes||!meRes.loggedIn) return location.href='/login.html';
    me = meRes.username;
    socket.emit('registerUser', me);
    await loadFriends();
    await loadRooms();
    loader.classList.add('hidden');
  }

  async function loadFriends(){
    // populate friend requests and friends
    const users = await api('/users');
    if(!users) return;
    recentUsersDiv.innerHTML='';
    users.forEach(u=>{
      if(u.username!==me){
        const div=document.createElement('div');
        div.className='list-item';
        div.textContent=u.username;
        recentUsersDiv.appendChild(div);
      }
    });
  }

  async function loadRooms(){
    const rooms = await api('/rooms');
    if(!rooms) return;
    roomsListDiv.innerHTML='';
    rooms.forEach(r=>{
      const div=document.createElement('div');
      div.className='list-item';
      div.textContent=r.name;
      div.onclick = ()=> openRoom(r.name);
      roomsListDiv.appendChild(div);
    });
  }

  function openRoom(name){
    current=name;
    chatOverlay.classList.remove('hidden');
    chatMessages.innerHTML='';
    if(!messageMap.has(name)) messageMap.set(name,[]);
    messageMap.get(name).forEach(msg => addMessage(msg));
  }

  function addMessage({from,text}){
    const div=document.createElement('div');
    div.className='chat-message'+(from===me?' me':'');
    div.innerHTML=`<div class="bubble"><b>${from}:</b> ${text}</div>`;
    chatMessages.appendChild(div);
    chatMessages.scrollTop=chatMessages.scrollHeight;
  }

  sendBtn.onclick = ()=>{
    if(!current||!chatInput.value) return;
    const msg={from:me,text:chatInput.value};
    socket.emit('chatMessage', {to:current,msg:msg});
    if(!messageMap.has(current)) messageMap.set(current,[]);
    messageMap.get(current).push(msg);
    addMessage(msg);
    chatInput.value='';
  }

  closeChatBtn.onclick=()=>{ chatOverlay.classList.add('hidden'); current=null; };

  socket.on('receiveMessage', ({from,to,msg})=>{
    if(to!==me) return;
    if(!messageMap.has(from)) messageMap.set(from,[]);
    messageMap.get(from).push(msg);
    if(current===from) addMessage(msg);
  });

  await init();
})();
</script>
</body>
</html>
